---
date: '2018-11-27T09:18:00.001-08:00'
description: ''
published: true
slug: 2018-11-27-automated-web-site-generation-using
tags:
- http://schemas.google.com/blogger/2008/kind#post
- legacy-blogger
time_to_read: 5
title: Automated web site generation using Bookdown, CircleCI, and Github
---

*This was originally posted on blogger [here](http://www.russpoldrack.org/2018/11/automated-web-site-generation-using.html)*.

<div>For my new open statistics book (<a href="http://statsthinking21.org/">Statistical Thinking for the 21st Century</a>), I used <a href="https://bookdown.org/yihui/bookdown/">Bookdown</a> which is a great tool for writing a book using RMarkdown. &nbsp;However, as the book came together, the time to build the book grew to more than 10 mins due to the many simulations and Bayesian model estimation. &nbsp;And since each output type (of which there are currently three: Gitbook, PDF, and EPUB) requires a separate build run, rebuilding the full book distribution became quite an undertaking. &nbsp;For this reason, I decided to implement an automated solution using the <a href="https://circleci.com/">CircleCI </a>continuous integration service. We already use this service for many of the software development projects in our lab (such as <a href="http://fmriprep.org/">fMRIPrep</a>&nbsp;and&nbsp;&nbsp;<a href="http://mriqc.org/">MRIQC</a>), so it was a natural choice for this project as well. </div><div><br /></div><div>The use of CircleCI for this project is made particularly easy by the fact that both the book source and the web site for the book are hosted on Github — the ability to set up hooks between Github and CircleCI allows two important features. First, it allows us to automatically trigger a rebuild of the site whenever there is a new push to the source repo. &nbsp;Second, it allows CircleCI to push a new copy of the book files to the separate repo that the site is served from. </div><div><br /></div><div>Here are the steps to setting this up - see the <a href="https://github.com/poldrack/psych10-book/blob/master/Makefile">Makefile</a> and <a href="https://github.com/poldrack/psych10-book/blob/master/.circleci/config.yml">CircleCI config.yml file</a> in the repo for questions. &nbsp;And if you come across anything that I missed please leave a comment below! </div><div><br /></div><ol><li><div><span style="font-weight: bold;">Create a CircleCI account linked to the relevant GitHub account.</span></div></li><li><div><span style="font-weight: bold;">Add the source repo to CircleCI.</span></div></li><li><div><span style="font-weight: bold;">Create the CircleCI config.yml file</span>. &nbsp;Here is the content of my config file, with comments added to explain each step: </div></li></ol><div><br /></div><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;">version: 2<br />jobs:<br />&nbsp;&nbsp;build:<br />&nbsp;&nbsp;&nbsp;&nbsp;docker:<br /># this is my custom Docker image<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- image: poldrack/statsthinking21 </span></blockquote><div><br /></div><div>CircleCI spins up a VM specified by a Docker image, to which we can then add any necessary additional software pieces. &nbsp;I initially started with an image with R and the tidyverse preinstalled (<a href="https://hub.docker.com/r/rocker/tidyverse/">https://hub.docker.com/r/rocker/tidyverse/</a>) but installing all of the R packages as well as the TeX distribution needed to compile the PDF took a very long time, quickly using up the 1,000 build minutes per month that come with the CircleCI free plan. &nbsp;In order to save this time I build a custom Docker container (<a href="https://github.com/poldrack/psych10-book/blob/master/Dockerfile">Dockerfile</a>) that incorporates all of the dependencies needed to build the book; this way, CircleCI can simply pull <a href="https://hub.docker.com/r/poldrack/statsthinking21/">the container from my DockerHub repo </a>and run it straight away rather than having to build a bunch of R packages. &nbsp;&nbsp; </div><div><br /></div><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;steps:<br />&nbsp; &nbsp; &nbsp; - add_ssh_keys:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fingerprints:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- "73:90:5e:75:b6:2c:3c:a3:46:51:4a:09:ac:d9:84:0f” </span></blockquote><div><br /></div><div>In order to be able to push to a github repo, CircleCI needs a way to authenticate itself. &nbsp;A relatively easy way to do this is to generate an SSH key and install the public key portion as a “deploy key” on the Github repo, then install the private key as an SSH key on CircleCI. &nbsp;I had problems with this until I realized that it requires a very specific type of SSH key (a PEM key using RSA encryption), which I generated on my Mac using the following command: </div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">ssh-keygen -m PEM -t rsa -C "<a href="mailto:poldrack@gmail.com">poldrack@gmail.com</a>” </span></div><div><br /></div><div><br /></div><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;"># check out the repo to the VM - it also becomes the working directory<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- checkout<br /># I forgot to install ssh in the docker image, so install it here as we will need it for the github push below<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- run: apt-get install -y ssh<br /># now run all of the rendering commands<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- run:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: rendering pdf<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command: |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make render-pdf<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- run:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: rendering epub<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command: |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make render-epub<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- run:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: rendering gitbook<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command: |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make render-gitbook </span></blockquote><div><br /></div><div>The Makefile in the source repo contains the commands to render the book in each of the three formats that we distribute: Gitbook, PDF, and EPUB. &nbsp;Here we build each of those. </div><div><br /></div><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;"># push the rendered site files to its repo on github<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- run:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: check out site repo<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command: |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cd /tmp<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ssh-keyscan <a href="http://github.com/">github.com</a> &gt;&gt; ~/.ssh/known_hosts</span></blockquote><div><br /></div><div>The ssh-keyscan command is necessary in order to allow headless operation of the ssh command necessary to access github below. &nbsp;Otherwise the git clone command will sit and wait at the host authentication prompt for a keypress that will never come.</div><div><br /></div><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;"># clone the site repo into a separate directory<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git clone <a href="mailto:git@github.com">git@github.com</a>:psych10/thinkstats.git<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cd thinkstats<br /># copy all of the site files into the site repo directory<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cp -r ~/project/_book/* .<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git add .<br /># necessary config to push<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git config --global user.email <a href="mailto:poldrack@gmail.com">poldrack@gmail.com</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git config --global user.name "Russ Poldrack"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git commit -m"automated update"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git push origin master</span></blockquote><!--?xml version="1.0" encoding="UTF-8"?--> <br /><div>That’s it! CircleCI should now build and deploy the book any time there is a new push to the repo. &nbsp;Don’t forget to add a CircleCI badge to the README to show off your work!&nbsp; &nbsp;</div>